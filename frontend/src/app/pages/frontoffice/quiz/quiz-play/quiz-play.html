<div class="w-full max-w-[1300px] mx-auto flex flex-col gap-8 pt-10 mt-32">

  <audio #bgMusic autoplay loop>
    <source src="assets/bgQuiz.mp3" type="audio/mpeg">
  </audio>

  <audio #clickSound src="assets/selected.mp3"></audio>

  <div *ngIf="loading()" class="alert alert-info text-sm">
    Carregando quiz‚Ä¶
  </div>

  <div *ngIf="!loading() && quiz()" class="flex flex-col w-full gap-1">
    <h1 class="text-2xl sm:text-3xl font-poppins text-black">
      {{ quiz()?.title }}
    </h1>

    <div class="w-full mt-1">
      <div class="w-full h-2 bg-gray-300">
        <div class="h-2 bg-redIsla transition-all duration-300"
          [style.width.%]="questions().length ? ((index() + 1) / questions().length) * 100 : 0"></div>
      </div>
      <div class="text-xs text-black mt-1">
        {{ index() + 1 }}/{{ questions().length }}
      </div>
    </div>
  </div>

  <ng-container *ngIf="current() as q; else empty">
    <div class="text-xl font-poppins text-black mt-4">
      {{ q.text }}
    </div>


    <div class="flex flex-col gap-4 mt-3">
      <button *ngFor="let opt of q.options" (click)="pickOption(q.id, opt.id)" class="border border-redIsla px-3 py-2 text-left font-poppins transition text-sm
                     hover:bg-redIsla hover:text-white" [class.bg-redIsla]="selectedByQuestion()[q.id] === opt.id"
        [class.text-white]="selectedByQuestion()[q.id] === opt.id">
        {{ opt.text }}
      </button>
    </div>

    <div class="flex justify-between items-center mt-6 mb-20 gap-3">
      <button (click)="quit()" class="bg-gray-200 text-gray-800 font-poppins px-5 py-2 text-sm
                   hover:bg-gray-300 transition">
        Sair
      </button>

      <div class="flex gap-2">
        <button (click)="prev()" [disabled]="!canPrev()" class="bg-gray-200 text-gray-800 font-poppins px-5 py-2 text-sm
                       disabled:bg-gray-200 disabled:text-gray-800
                       hover:bg-gray-300 transition
                       disabled:opacity-40 disabled:cursor-not-allowed
                       disabled:hover:bg-gray-200">
          Anterior
        </button>

        <button (click)="canNext() ? next() : finish()" [disabled]="submitting()" class="bg-redIsla text-white font-poppins px-5 py-2 text-sm
                       hover:bg-red-800 transition
                       disabled:opacity-40 disabled:cursor-not-allowed">
          {{ canNext() ? 'Pr√≥xima' : (submitting() ? 'A enviar‚Ä¶' : 'Finalizar') }}
        </button>
      </div>
    </div>
  </ng-container>


  <div *ngIf="showModal()" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white shadow-lg p-6 max-w-sm w-full text-center">
      <h2 class="text-lg font-poppins mb-3">{{ modalTitle() }}</h2>
      <p class="mb-4 font-poppins text-sm">{{ modalMessage() }}</p>

      <div class="flex justify-center gap-3">
        <button (click)="closeModal()" class="bg-gray-200 text-gray-800 px-4 py-2 hover:bg-gray-300 transition text-sm">
          Fechar
        </button>

        <button *ngIf="modalAction" (click)="modalAction()"
          class="bg-redIsla text-white px-4 py-2 hover:bg-red-800 transition text-sm">
          Confirmar
        </button>
      </div>
    </div>
  </div>


  <div *ngIf="showScoreModal()" class="fixed inset-0 flex items-center justify-center z-50">
    <div class="bg-white shadow-xl p-6 max-w-sm w-full text-center">
      <h2 class="text-xl font-poppins mb-3 text-green-600">
        Quiz conclu√≠do üéâ
      </h2>

      <p class="text-sm mb-4">
        A tua pontua√ß√£o foi:
        <span class="font-poppins text-xl block mt-1">
          {{ finalScore() }}%
        </span>
      </p>

      <div *ngIf="badgeAwarded()" class="mt-4">
        <p class="text-sm font-poppins mb-2">
          Parab√©ns! Ganhaste uma badge:
          <strong>{{ badgeAwarded()?.name }}</strong>
        </p>

        <img
          *ngIf="badgeImageUrl()"
          [src]="badgeImageUrl()"
          alt="Badge"
          class="w-20 h-20 mx-auto object-cover"
          (error)="onBadgeImgError($event)"
        />
      </div>


      <button (click)="closeScoreModal()"
        class="bg-redIsla text-white font-poppins px-5 py-2 hover:bg-red-800 transition text-sm">
        Continuar
      </button>
    </div>
  </div>

  <ng-template #empty>
    <div class="text-black mt-6 mb-6 text-sm">
      Este quiz n√£o possui quest√µes.
    </div>
  </ng-template>

</div>