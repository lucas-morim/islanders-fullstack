<section class="page-header sticky-top-under-app">
  <div class="d-flex align-items-center justify-content-between">
    <h2 class="mb-0">Editar questão</h2>
  </div>
</section>

<div *ngIf="loading()" class="alert alert-info">Carregando…</div>

<form [formGroup]="form" novalidate *ngIf="!loading()">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <label class="form-label">Texto da questão</label>
          <textarea class="form-control" rows="3" formControlName="text"></textarea>
          <div class="invalid-feedback d-block" *ngIf="f['text'].touched && f['text'].errors">
            {{ f['text'].errors['required'] ? 'Texto é obrigatório.' : '' }}
            {{ f['text'].errors['maxlength'] ? 'Máximo de 500 caracteres.' : '' }}
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <label class="form-label">Quiz</label>
          <select class="form-select" formControlName="quiz_id">
            <option [ngValue]="null">Selecione…</option>
            <option *ngFor="let q of quizzes()" [value]="q.id">
              {{ q.title }}
            </option>
          </select>
          <div class="invalid-feedback d-block" *ngIf="f['quiz_id'].touched && f['quiz_id'].errors">
            {{ f['quiz_id'].errors['required'] ? 'Quiz é obrigatório.' : '' }}
          </div>
        </div>

        <div class="col-12">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <label class="form-label mb-1">Opções</label>
              <div class="small text-muted">Selecione até <strong>4</strong> e marque a correta.</div>
            </div>

            <button class="btn btn-outline-primary" type="button" (click)="openOptionsModal()">
              Selecionar opções
            </button>
          </div>

          <div class="mt-2 selected-wrap" *ngIf="selectedOptions().length > 0; else none">
            <span class="badge bg-secondary-subtle text-secondary border me-2 mb-2"
                  *ngFor="let opt of selectedOptions()">
              {{ opt.text }}
              <span class="text-success fw-semibold" *ngIf="opt.id === correctOptionId()"> (correta)</span>
            </span>
          </div>

          <ng-template #none>
            <div class="alert alert-warning mb-0 mt-2">Nenhuma opção selecionada.</div>
          </ng-template>

          <div class="text-danger small mt-1"
               *ngIf="selectedOptionIds().length > 0 && !correctOptionId()">
            Selecione qual opção é a correta.
          </div>
        </div>
      </div>
    </div>

    <div class="card-body d-flex justify-content-end gap-2 border-top bg-white">
      <button class="btn btn-outline-secondary" type="button" (click)="cancel()">Cancelar</button>

      <button class="btn btn-primary isla-color-bg"
              type="button"
              [disabled]="!canSubmit()"
              (click)="submit()">
        <span *ngIf="!submitting(); else saving">Salvar</span>
      </button>

      <ng-template #saving>
        <span class="spinner-border spinner-border-sm me-1"></span> Salvando…
      </ng-template>
    </div>
  </div>
</form>

<!-- MODAL -->
<div class="modal-backdrop-custom" *ngIf="optionsModalOpen()"></div>

<div class="modal-custom" *ngIf="optionsModalOpen()">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title">Selecionar opções</h5>
        <button type="button" class="btn-close" (click)="closeOptionsModal()"></button>
      </div>

      <div class="modal-body">
        <div class="row g-2 align-items-end mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Buscar</label>
            <input type="search"
                   class="form-control"
                   [ngModel]="optionsSearch()"
                   (ngModelChange)="optionsSearch.set($event)"
                   [ngModelOptions]="{standalone:true}">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Criar nova opção</label>
            <div class="input-group">
              <input class="form-control"
                     [ngModel]="newOptionText()"
                     (ngModelChange)="newOptionText.set($event)"
                     [ngModelOptions]="{standalone:true}">
              <button class="btn btn-outline-primary"
                      type="button"
                      (click)="createOption()"
                      [disabled]="creatingOption() || !newOptionText().trim()">
                Criar
              </button>
            </div>
          </div>
        </div>

        <div class="options-list list-group">
          <label class="list-group-item d-flex align-items-center justify-content-between option-row"
                 [class.in-use]="usageCount(opt.id) > 0"
                 *ngFor="let opt of filteredOptions()">

            <div class="d-flex align-items-center gap-2 flex-grow-1">
              <input type="checkbox"
                     class="form-check-input"
                     [checked]="isSelected(opt.id)"
                     [disabled]="!canSelectOption(opt.id)"
                     (change)="toggleOption(opt.id)">

              <ng-container *ngIf="editingId() !== opt.id; else editTpl">
                <span>{{ opt.text }}</span>
              </ng-container>

              <ng-template #editTpl>
                <input class="form-control form-control-sm"
                       style="max-width:260px;"
                       [ngModel]="editText()"
                       (ngModelChange)="editText.set($event)"
                       [ngModelOptions]="{standalone:true}">
              </ng-template>

              <span class="badge bg-light text-dark border ms-2">
                Em uso: {{ usageCount(opt.id) }}
              </span>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="form-check form-check-inline mb-0">
                <input class="form-check-input"
                       type="radio"
                       name="correctOption"
                       [checked]="correctOptionId() === opt.id"
                       [disabled]="!isSelected(opt.id)"
                       (change)="setCorrect(opt.id)">
                <label class="form-check-label small">Correta</label>
              </div>

              <ng-container *ngIf="editingId() !== opt.id; else editActions">
                <button class="btn btn-sm btn-outline-secondary" type="button" (click)="startEdit(opt)">
                  Editar
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        type="button"
                        [disabled]="!canDelete(opt.id) || deletingId() === opt.id"
                        [title]="canDelete(opt.id) ? 'Apagar' : 'Em uso — não pode apagar'"
                        (click)="deleteOption(opt)">
                  <span *ngIf="deletingId() !== opt.id">Apagar</span>
                  <span *ngIf="deletingId() === opt.id" class="spinner-border spinner-border-sm"></span>
                </button>
              </ng-container>

              <ng-template #editActions>
                <button class="btn btn-sm btn-success" type="button" [disabled]="savingEdit()" (click)="saveEdit(opt)">
                  Salvar
                </button>
                <button class="btn btn-sm btn-outline-secondary" type="button" (click)="cancelEdit()">
                  Cancelar
                </button>
              </ng-template>
            </div>

          </label>

          <div *ngIf="filteredOptions().length === 0" class="text-muted small p-2">
            Nenhuma opção encontrada.
          </div>
        </div>

        <div class="small text-muted mt-2">
          Selecionadas: <strong>{{ selectedOptionIds().length }}</strong>/4
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" (click)="closeOptionsModal()">Cancelar</button>
        <button class="btn btn-primary isla-color-bg" type="button" (click)="confirmOptions()">Confirmar</button>
      </div>
    </div>
  </div>
</div>
